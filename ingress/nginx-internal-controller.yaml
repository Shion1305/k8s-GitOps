apiVersion: apps/v1
kind: Deployment
metadata:
  name: ingress-nginx-internal-controller
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx-internal
    app.kubernetes.io/instance: ingress-nginx-internal
    app.kubernetes.io/component: controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: ingress-nginx-internal
      app.kubernetes.io/instance: ingress-nginx-internal
      app.kubernetes.io/component: controller
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ingress-nginx-internal
        app.kubernetes.io/instance: ingress-nginx-internal
        app.kubernetes.io/component: controller
    spec:
      # Deploy on the node where Longhorn runs (10.0.0.4)
      nodeSelector:
        kubernetes.io/hostname: shion-ubuntu-2505
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
      serviceAccountName: ingress-nginx
      # Use host network to bind directly to node IP (10.0.0.4)
      # This makes the controller accessible at 10.0.0.4:80 and 10.0.0.4:443
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - name: controller
          image: registry.k8s.io/ingress-nginx/controller:v1.14.3
          args:
            - /nginx-ingress-controller
            - --election-id=ingress-nginx-internal-leader
            - --controller-class=k8s.io/ingress-nginx-internal
            - --ingress-class=nginx-internal
            - --configmap=$(POD_NAMESPACE)/ingress-nginx-internal-controller
            - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services
            - --http-port=80
            - --https-port=443
            - --default-ssl-certificate=ingress-nginx/nginx-tls-secret
            - --v=2
            - --enable-ssl-passthrough=false
          env:
            - name: HOST_IP
              valueFrom: {fieldRef: {fieldPath: status.hostIP}}
            - name: POD_NAME
              valueFrom: {fieldRef: {fieldPath: metadata.name}}
            - name: POD_NAMESPACE
              valueFrom: {fieldRef: {fieldPath: metadata.namespace}}
          ports:
            - name: http
              containerPort: 80
              hostPort: 80
            - name: https
              containerPort: 443
              hostPort: 443
            - name: postgres
              containerPort: 5432
              hostPort: 5432
              protocol: TCP
          securityContext:
            runAsNonRoot: true
            runAsUser: 101
            runAsGroup: 101
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
              add: ["NET_BIND_SERVICE"]
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ingress-nginx-internal-controller
  namespace: ingress-nginx
data:
  # IP whitelist for internal network
  # Only allow access from 10.0.0.0/24 subnet (internal network)
  # External users will be blocked even if they somehow reach this controller
  whitelist-source-range: "10.0.0.0/24"
  # Allow snippet annotations for custom configurations
  allow-snippet-annotations: "true"
  annotations-risk-level: "Critical"
  # Force SSL redirect for HTTPS
  ssl-redirect: "true"
  force-ssl-redirect: "true"
  # Bind only to the specified dynamic host IP
  bind-address: $(HOST_IP)
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: tcp-services
  namespace: ingress-nginx
data:
  # Map port 5432 on the ingress controller to the atc postgres service
  "5432": "postgres-operator-deployment/atc-postgres-tcp:5432"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: ingress-nginx-internal
rules:
  - apiGroups: [""]
    resources: ["configmaps", "endpoints", "nodes", "pods", "secrets", "namespaces"]
    verbs: ["list", "watch"]
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["list", "watch"]
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get"]
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "patch"]
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses/status"]
    verbs: ["update"]
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingressclasses"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["discovery.k8s.io"]
    resources: ["endpointslices"]
    verbs: ["list", "watch", "get"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "create", "update", "patch", "delete"]
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "list", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: ingress-nginx-internal
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ingress-nginx-internal
subjects:
  - kind: ServiceAccount
    name: ingress-nginx
    namespace: ingress-nginx
---
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  name: nginx-internal
  labels:
    app.kubernetes.io/name: ingress-nginx-internal
    app.kubernetes.io/instance: ingress-nginx-internal
spec:
  controller: k8s.io/ingress-nginx-internal
