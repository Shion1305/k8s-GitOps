apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: argocd
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://argoproj.github.io/argo-helm
    chart: argo-cd
    targetRevision: 9.0.5  # ArgoCD v3.1.9
    helm:
      valuesObject:
        global:
          domain: argocd.k.shion1305.com

        configs:
          cm:
            accounts.admin.enabled: "true"
            url: https://argocd.k.shion1305.com
            dex.config: |
              connectors:
              - type: github
                id: github
                name: GitHub
                config:
                  clientID: $github-oauth-secret:dex.github.clientID
                  clientSecret: $github-oauth-secret:dex.github.clientSecret
                  redirectURI: https://argocd.k.shion1305.com/api/dex/callback
            resource.exclusions: |
              ### Network resources created by the Kubernetes control plane and excluded to reduce the number of watched events and UI clutter
              - apiGroups:
                - ''
                - discovery.k8s.io
                kinds:
                - Endpoints
                - EndpointSlice
              ### Internal Kubernetes resources excluded reduce the number of watched events
              - apiGroups:
                - coordination.k8s.io
                kinds:
                - Lease
              ### Internal Kubernetes Authz/Authn resources excluded reduce the number of watched events
              - apiGroups:
                - authentication.k8s.io
                - authorization.k8s.io
                kinds:
                - SelfSubjectReview
                - TokenReview
                - LocalSubjectAccessReview
                - SelfSubjectAccessReview
                - SelfSubjectRulesReview
                - SubjectAccessReview
              ### Intermediate Certificate Request excluded reduce the number of watched events
              - apiGroups:
                - certificates.k8s.io
                kinds:
                - CertificateSigningRequest
              - apiGroups:
                - cert-manager.io
                kinds:
                - CertificateRequest
              ### Cilium internal resources excluded reduce the number of watched events and UI Clutter
              - apiGroups:
                - cilium.io
                kinds:
                - CiliumIdentity
                - CiliumEndpoint
                - CiliumEndpointSlice
              ### Kyverno intermediate and reporting resources excluded reduce the number of watched events and improve performance
              - apiGroups:
                - kyverno.io
                - reports.kyverno.io
                - wgpolicyk8s.io
                kinds:
                - PolicyReport
                - ClusterPolicyReport
                - EphemeralReport
                - ClusterEphemeralReport
                - AdmissionReport
                - ClusterAdmissionReport
                - BackgroundScanReport
                - ClusterBackgroundScanReport
                - UpdateRequest
            resource.customizations.ignoreResourceUpdates.ConfigMap: |
              jqPathExpressions:
                - '.metadata.annotations."cluster-autoscaler.kubernetes.io/last-updated"'
                - '.metadata.annotations."control-plane.alpha.kubernetes.io/leader"'
            resource.customizations.ignoreResourceUpdates.Endpoints: |
              jsonPointers:
                - /metadata
                - /subsets
            resource.customizations.ignoreResourceUpdates.all: |
              jsonPointers:
                - /status
            resource.customizations.ignoreResourceUpdates.apps_ReplicaSet: |
              jqPathExpressions:
                - '.metadata.annotations."deployment.kubernetes.io/desired-replicas"'
                - '.metadata.annotations."deployment.kubernetes.io/max-replicas"'
                - '.metadata.annotations."rollout.argoproj.io/desired-replicas"'
            resource.customizations.ignoreResourceUpdates.argoproj.io_Application: |
              jqPathExpressions:
                - '.metadata.annotations."notified.notifications.argoproj.io"'
                - '.metadata.annotations."argocd.argoproj.io/refresh"'
                - '.metadata.annotations."argocd.argoproj.io/hydrate"'
                - '.operation'
            resource.customizations.ignoreResourceUpdates.argoproj.io_Rollout: |
              jqPathExpressions:
                - '.metadata.annotations."notified.notifications.argoproj.io"'
            resource.customizations.ignoreResourceUpdates.autoscaling_HorizontalPodAutoscaler: |
              jqPathExpressions:
                - '.metadata.annotations."autoscaling.alpha.kubernetes.io/behavior"'
                - '.metadata.annotations."autoscaling.alpha.kubernetes.io/conditions"'
                - '.metadata.annotations."autoscaling.alpha.kubernetes.io/metrics"'
                - '.metadata.annotations."autoscaling.alpha.kubernetes.io/current-metrics"'
            resource.customizations.ignoreResourceUpdates.discovery.k8s.io_EndpointSlice: |
              jsonPointers:
                - /metadata
                - /endpoints
                - /ports
          rbac:
            policy.default: role:admin
            policy.csv: ""
          secret:
            createSecret: false
          params: {}

        server:
          ingress:
            enabled: false
          service:
            type: ClusterIP

        dex:
          enabled: true

        redis:
          enabled: true

        controller:
          replicas: 1

        repoServer:
          replicas: 1

        applicationSet:
          replicas: 1

        notifications:
          enabled: true

  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
      - ServerSideApply=true
